"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { onAuthStateChanged, signOut, User } from "firebase/auth";
import { doc, getDoc, setDoc, serverTimestamp } from "firebase/firestore";
import { auth, db } from "@/lib/firebase";
import { reserveUsernameAndCreateProfile } from "@/lib/profileService";

type LinkItem = { title: string; url: string };
type ProductItem = { title: string; price?: number };

type ProfileDoc = {
  ownerUid: string;
  username: string;
  displayName: string;
  bio: string;
  photoURL: string;
  published: boolean;
  links: LinkItem[];
  products: ProductItem[];
};

const RESERVED = new Set([
  "login","register","dashboard","api","repair-profile","pricing","terms","privacy",
  "admin","_next","favicon.ico","robots.txt","sitemap.xml","assets","static"
]);

function normUsername(s: string) {
  return s.trim().toLowerCase();
}
function isValidUsername(s: string) {
  if (!/^[a-z0-9_]{3,20}$/.test(s)) return false;
  if (RESERVED.has(s)) return false;
  return true;
}

export default function DashboardPage() {
  const router = useRouter();

  const [user, setUser] = useState<User | null>(null);
  const [checking, setChecking] = useState(true);

  const [existingUsername, setExistingUsername] = useState<string | null>(null);

  // create username
  const [usernameInput, setUsernameInput] = useState("");
  const [displayNameInput, setDisplayNameInput] = useState("");
  const [creating, setCreating] = useState(false);

  // profile editor
  const [profile, setProfile] = useState<ProfileDoc | null>(null);
  const [saving, setSaving] = useState(false);

  // draft fields
  const [displayName, setDisplayName] = useState("");
  const [bio, setBio] = useState("");
  const [published, setPublished] = useState(true);
  const [links, setLinks] = useState<LinkItem[]>([]);
  const [products, setProducts] = useState<ProductItem[]>([]);

  // add link/product
  const [linkTitle, setLinkTitle] = useState("");
  const [linkUrl, setLinkUrl] = useState("");

  const [prodTitle, setProdTitle] = useState("");
  const [prodPrice, setProdPrice] = useState("");

  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);

  const profileUrl = useMemo(() => {
    if (!existingUsername) return null;
    return `/${existingUsername}`;
  }, [existingUsername]);

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (u) => {
      if (!u) {
        router.replace("/login");
        return;
      }

      setUser(u);
      setErr(null);
      setMsg(null);
      setChecking(true);

      try {
        const uSnap = await getDoc(doc(db, "users", u.uid));
        const uname = uSnap.exists() ? (uSnap.data() as any).username ?? null : null;

        if (!uname) {
          setExisting
cd "$env:USERPROFILE\Desktop\biolink"

$dashPath = Join-Path (Get-Location) 'src\app\dashboard\page.tsx'
Copy-Item -LiteralPath $dashPath -Destination ($dashPath + ".bak") -Force

$content = @'
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { onAuthStateChanged, signOut, User } from "firebase/auth";
import { doc, getDoc, setDoc, serverTimestamp } from "firebase/firestore";
import { auth, db } from "@/lib/firebase";
import { reserveUsernameAndCreateProfile } from "@/lib/profileService";

type LinkItem = { title: string; url: string };
type ProductItem = { title: string; price?: number };

type ProfileDoc = {
  ownerUid: string;
  username: string;
  displayName: string;
  bio: string;
  photoURL: string;
  published: boolean;
  links: LinkItem[];
  products: ProductItem[];
};

const RESERVED = new Set([
  "login","register","dashboard","api","repair-profile","pricing","terms","privacy",
  "admin","_next","favicon.ico","robots.txt","sitemap.xml","assets","static"
]);

function normUsername(s: string) {
  return s.trim().toLowerCase();
}
function isValidUsername(s: string) {
  if (!/^[a-z0-9_]{3,20}$/.test(s)) return false;
  if (RESERVED.has(s)) return false;
  return true;
}

export default function DashboardPage() {
  const router = useRouter();

  const [user, setUser] = useState<User | null>(null);
  const [checking, setChecking] = useState(true);

  const [existingUsername, setExistingUsername] = useState<string | null>(null);

  // create username
  const [usernameInput, setUsernameInput] = useState("");
  const [displayNameInput, setDisplayNameInput] = useState("");
  const [creating, setCreating] = useState(false);

  // profile editor
  const [profile, setProfile] = useState<ProfileDoc | null>(null);
  const [saving, setSaving] = useState(false);

  // draft fields
  const [displayName, setDisplayName] = useState("");
  const [bio, setBio] = useState("");
  const [published, setPublished] = useState(true);
  const [links, setLinks] = useState<LinkItem[]>([]);
  const [products, setProducts] = useState<ProductItem[]>([]);

  // add link/product
  const [linkTitle, setLinkTitle] = useState("");
  const [linkUrl, setLinkUrl] = useState("");

  const [prodTitle, setProdTitle] = useState("");
  const [prodPrice, setProdPrice] = useState("");

  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);

  const profileUrl = useMemo(() => {
    if (!existingUsername) return null;
    return `/${existingUsername}`;
  }, [existingUsername]);

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (u) => {
      if (!u) {
        router.replace("/login");
        return;
      }

      setUser(u);
      setErr(null);
      setMsg(null);
      setChecking(true);

      try {
        const uSnap = await getDoc(doc(db, "users", u.uid));
        const uname = uSnap.exists() ? (uSnap.data() as any).username ?? null : null;

        if (!uname) {
          setExistingUsername(null);
          setProfile(null);
          setChecking(false);
          return;
        }

        const normalized = normUsername(String(uname));
        setExistingUsername(normalized);

        // Load profile doc; if missing, create default
        const pRef = doc(db, "profiles", normalized);
        const pSnap = await getDoc(pRef);

        let p: ProfileDoc;
        if (pSnap.exists()) {
          p = pSnap.data() as any;
        } else {
          p = {
            ownerUid: u.uid,
            username: normalized,
            displayName: u.displayName || normalized,
            bio: "",
            photoURL: u.photoURL || "",
            published: true,
            links: [],
            products: [],
          };
          await setDoc(pRef, {
            ...p,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          });
        }

        setProfile(p);
        setDisplayName(p.displayName || normalized);
        setBio(p.bio || "");
        setPublished(!!p.published);
        setLinks(Array.isArray(p.links) ? p.links : []);
        setProducts(Array.isArray(p.products) ? p.products : []);
      } catch (e: any) {
        setErr(e?.message || "Error cargando dashboard");
      } finally {
        setChecking(false);
      }
    });

    return () => unsub();
  }, [router]);

  async function createUsername() {
    if (!user) return;

    setErr(null);
    setMsg(null);

    const uname = normUsername(usernameInput);

    if (!isValidUsername(uname)) {
      setErr("Username inválido. Usa 3-20 caracteres: a-z, 0-9, _. Evita palabras reservadas (login, dashboard, etc).");
      return;
    }

    setCreating(true);
    try {
      const finalUsername = await reserveUsernameAndCreateProfile({
        uid: user.uid,
        username: uname,
        displayName: displayNameInput || uname,
      });

      setExistingUsername(finalUsername demonstrating finalUsername);
      router.push(`/${finalUsername}`);
    } catch (e: any) {
      setErr(e?.message || "No se pudo crear el perfil");
    } finally {
      setCreating(false);
    }
  }

  function addLink() {
    setErr(null);
    const t = linkTitle.trim();
    const u = linkUrl.trim();
    if (!t || !u) return;
    setLinks((prev) => [...prev, { title: t, url: u }]);
    setLinkTitle("");
    setLinkUrl("");
  }

  function removeLink(i: number) {
    setLinks((prev) => prev.filter((_, idx) => idx !== i));
  }

  function addProduct() {
    setErr(null);
    const t = prodTitle.trim();
    if (!t) return;

    const raw = prodPrice.trim();
    const price = raw ? Number(raw) : undefined;
    if (raw && (Number.isNaN(price) || price! < 0)) {
      setErr("Precio inválido");
      return;
    }

    setProducts((prev) => [...prev, { title: t, price }]);
    setProdTitle("");
    setProdPrice("");
  }

  function removeProduct(i: number) {
    setProducts((prev) => prev.filter((_, idx) => idx !== i));
  }

  async function saveProfile() {
    if (!user || !existingUsername) return;

    setErr(null);
    setMsg(null);
    setSaving(true);

    try {
      const pRef = doc(db, "profiles", existingUsername);

      await setDoc(
        pRef,
        {
          ownerUid: user.uid,
          username: existingUsername,
          displayName: displayName.trim() || existingUsername,
          bio: bio,
          photoURL: user.photoURL || "",
          published: !!published,
          links: links,
          products: products,
          updatedAt: serverTimestamp(),
        },
        { merge: true }
      );

      setMsg("Guardado ✅");
    } catch (e: any) {
      setErr(e?.message || "Error guardando");
    } finally {
      setSaving(false);
    }
  }

  if (checking) return <div className="p-6">Cargando...</div>;

  if (!user) return null;

  return (
    <div className="mx-auto max-w-2xl px-4 py-10">
      <div className="flex items-center justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Dashboard</h1>
          <p className="text-sm text-neutral-500">Configura tu perfil público y tu tienda.</p>
        </div>
        <button className="rounded-xl border px-3 py-2 text-sm" onClick={() => signOut(auth)}>
          Salir
        </button>
      </div>

      {err && (
        <div className="mt-4 rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700">
          {err}
        </div>
      )}
      {msg && (
        <div className="mt-4 rounded-xl border border-green-200 bg-green-50 p-3 text-sm text-green-700">
          {msg}
        </div>
      )}

      {!existingUsername ? (
        <div className="mt-6 rounded-2xl border p-5">
          <h2 className="text-lg font-semibold">Crea tu perfil</h2>
          <p className="text-sm text-neutral-600 mt-1">Elige tu username (será tu URL).</p>

          <div className="mt-4 space-y-3">
            <input
              className="w-full rounded-xl border px-3 py-2"
              placeholder="Username (ej: sulam)"
              value={usernameInput}
              onChange={(e) => setUsernameInput(e.target.value)}
            />
            <input
              className="w-full rounded-xl border px-3 py-2"
              placeholder="Nombre público (opcional)"
              value={displayNameInput}
              onChange={(e) => setDisplayNameInput(e.target.value)}
            />
            <button
              disabled={creating}
              onClick={createUsername}
              className="w-full rounded-xl bg-black text-white py-2 font-medium disabled:opacity-60"
            >
              {creating ? "Creando..." : "Crear perfil"}
            </button>

            <p className="text-xs text-neutral-500">
              Permitido: a-z, 0-9, _ (3-20). Evita palabras reservadas.
            </p>
          </div>
        </div>
      ) : (
        <>
          <div className="mt-6 rounded-2xl border p-5">
            <div className="flex items-center justify-between gap-2">
              <div>
                <div className="text-sm text-neutral-500">Tu URL pública</div>
                <div className="text-lg font-semibold">/{existingUsername}</div>
              </div>
              {profileUrl ? (
                <Link className="rounded-xl bg-black px-4 py-2 text-sm text-white" href={profileUrl}>
                  Ver perfil
                </Link>
              ) : null}
            </div>
          </div>

          <div className="mt-6 rounded-2xl border p-5 space-y-4">
            <h2 className="text-lg font-semibold">Perfil</h2>

            <div className="space-y-2">
              <label className="text-sm font-medium">Nombre público</label>
              <input className="w-full rounded-xl border px-3 py-2" value={displayName} onChange={(e) => setDisplayName(e.target.value)} />
            </div>

            <div className="space-y-2">
              <label className="text-sm font-medium">Bio</label>
              <textarea className="w-full rounded-xl border px-3 py-2 min-h-[110px]" value={bio} onChange={(e) => setBio(e.target.value)} />
            </div>

            <label className="flex items-center gap-2 text-sm">
              <input type="checkbox" checked={published} onChange={(e) => setPublished(e.target.checked)} />
              Publicar perfil (si está desactivado, solo tú lo verás)
            </label>
          </div>

          <div className="mt-6 rounded-2xl border p-5 space-y-4">
            <h2 className="text-lg font-semibold">Links</h2>

            <div className="grid gap-2">
              {(links ?? []).map((l, i) => (
                <div key={i} className="flex items-center justify-between gap-3 rounded-xl border px-3 py-2">
                  <div className="min-w-0">
                    <div className="font-medium truncate">{l.title}</div>
                    <div className="text-xs text-neutral-500 truncate">{l.url}</div>
                  </div>
                  <button className="text-sm underline" onClick={() => removeLink(i)}>Quitar</button>
                </div>
              ))}
              {(links ?? []).length === 0 ? (
                <div className="text-sm text-neutral-600">Aún no tienes links.</div>
              ) : null}
            </div>

            <div className="grid gap-2">
              <input className="w-full rounded-xl border px-3 py-2" placeholder="Título (ej: WhatsApp)" value={linkTitle} onChange={(e) => setLinkTitle(e.target.value)} />
              <input className="w-full rounded-xl border px-3 py-2" placeholder="URL (https://...)" value={linkUrl} onChange={(e) => setLinkUrl(e.target.value)} />
              <button className="rounded-xl border px-4 py-2 text-sm" onClick={addLink}>Agregar link</button>
            </div>
          </div>

          <div className="mt-6 rounded-2xl border p-5 space-y-4">
            <h2 className="text-lg font-semibold">Productos</h2>

            <div className="grid gap-2">
              {(products ?? []).map((p, i) => (
                <div key={i} className="flex items-center justify-between gap-3 rounded-xl border px-3 py-2">
                  <div className="min-w-0">
                    <div className="font-medium truncate">{p.title}</div>
                    {typeof p.price === "number" ? (
                      <div className="text-xs text-neutral-500">${p.price.toFixed(2)}</div>
                    ) : (
                      <div className="text-xs text-neutral-500">Sin precio</div>
                    )}
                  </div>
                  <button className="text-sm underline" onClick={() => removeProduct(i)}>Quitar</button>
                </div>
              ))}
              {(products ?? []).length === 0 ? (
                <div className="text-sm text-neutral-600">Aún no tienes productos.</div>
              ) : null}
            </div>

            <div className="grid gap-2">
              <input className="w-full rounded-xl border px-3 py-2" placeholder="Producto (ej: Curso de mecánica)" value={prodTitle} onChange={(e) => setProdTitle(e.target.value)} />
              <input className="w-full rounded-xl border px-3 py-2" placeholder="Precio (opcional) ej: 9.99" value={prodPrice} onChange={(e) => setProdPrice(e.target.value)} />
              <button className="rounded-xl border px-4 py-2 text-sm" onClick={addProduct}>Agregar producto</button>
            </div>
          </div>

          <div className="mt-6">
            <button
              disabled={saving}
              onClick={saveProfile}
              className="w-full rounded-xl bg-black text-white py-3 font-medium disabled:opacity-60"
            >
              {saving ? "Guardando..." : "Guardar cambios"}
            </button>
          </div>
        </>
      )}
    </div>
  );
}